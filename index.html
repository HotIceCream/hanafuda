<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–•–∞–Ω–∞—Ñ—É–¥–∞ - –ü–æ–¥—Å—á–µ—Ç –æ—á–∫–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .setup-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .setup-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .setup-row label {
            min-width: 120px;
            font-weight: 500;
        }

        .setup-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 150px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .scores-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .player-score h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .player-score .points {
            font-size: 32px;
            font-weight: bold;
        }

        .deal-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .deal-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .deal-number {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .winner-select {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .winner-select label {
            font-weight: 500;
        }

        .winner-buttons {
            display: flex;
            gap: 10px;
        }

        .winner-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 120px;
            text-align: center;
        }

        .winner-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .winner-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }

        .winner-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .koi-koi-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .koi-koi-input label {
            font-weight: 500;
        }

        .number-input-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .number-input-wrapper input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .number-input-wrapper input::-webkit-outer-spin-button,
        .number-input-wrapper input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .number-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
        }

        .number-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .number-btn:active {
            background: #dee2e6;
            transform: scale(0.95);
        }

        .number-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .koi-koi-input input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .yaku-section {
            margin-top: 15px;
        }

        .yaku-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .yaku-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .yaku-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
            position: relative;
        }

        .yaku-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .yaku-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }

        .yaku-btn .points {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .yaku-btn.active .points {
            opacity: 1;
        }

        .yaku-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background: #e9ecef;
            border-color: #ced4da;
        }

        .yaku-btn.disabled .points {
            opacity: 0.5;
        }

        .yaku-btn .extra-cards-input {
            margin-top: 8px;
            display: none;
        }

        .yaku-btn.active .extra-cards-input {
            display: block;
        }

        .yaku-btn .extra-cards-input input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            margin-top: 4px;
        }

        .yaku-btn.active .extra-cards-input input {
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .yaku-btn.active .extra-cards-input label {
            font-size: 11px;
            display: block;
            margin-bottom: 4px;
        }

        .deal-result {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .deal-result.show {
            display: block;
        }

        .deal-result .points-earned {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        .history-section {
            margin-top: 20px;
        }

        .history-section h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .history-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-content {
            flex: 1;
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-edit {
            background: #ffc107;
            color: #000;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        /* Mobile adaptations */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 8px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 15px;
            }

            .setup-section {
                padding: 12px;
            }

            .setup-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .setup-row label {
                min-width: auto;
                font-size: 14px;
            }

            .setup-row input {
                min-width: auto;
                width: 100%;
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .scores-section {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .player-score {
                padding: 12px;
            }

            .player-score h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .player-score .points {
                font-size: 28px;
            }

            .deal-section {
                padding: 12px;
            }

            .deal-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .deal-number {
                font-size: 16px;
            }

            .winner-select {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }

            .winner-select label {
                margin-bottom: 8px;
            }

            .winner-buttons {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .winner-btn {
                width: 100%;
                min-width: auto;
                padding: 12px;
                font-size: 16px;
            }

            .koi-koi-input {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }

            .koi-koi-input label {
                margin-bottom: 8px;
            }

            .koi-koi-input input {
                width: 100%;
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .number-input-wrapper {
                width: 100%;
            }

            .number-input-wrapper input {
                flex: 1;
                width: auto;
            }

            .number-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .yaku-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 6px;
            }

            .yaku-btn {
                padding: 12px 8px;
                font-size: 12px;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .yaku-btn .points {
                font-size: 10px;
                margin-top: 4px;
            }

            .yaku-btn .extra-cards-input {
                width: 100%;
                margin-top: 8px;
            }

            .yaku-btn .extra-cards-input input {
                width: 100%;
                padding: 6px;
                font-size: 14px;
            }

            .deal-result {
                padding: 12px;
                font-size: 14px;
            }

            .deal-result .points-earned {
                font-size: 16px;
            }

            .actions {
                flex-direction: column;
                width: 100%;
            }

            .actions .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            .history-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .history-item-content {
                width: 100%;
            }

            .history-item-actions {
                width: 100%;
                justify-content: stretch;
            }

            .btn-edit {
                flex: 1;
                padding: 10px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
                border-radius: 6px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 12px;
            }

            .yaku-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .yaku-btn {
                padding: 10px 6px;
                font-size: 11px;
                min-height: 55px;
            }

            .player-score .points {
                font-size: 24px;
            }

            .deal-number {
                font-size: 14px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .yaku-btn:hover {
                transform: none;
            }

            .yaku-btn:active {
                transform: scale(0.98);
                background: #5568d3;
            }

            .winner-btn:active {
                transform: scale(0.98);
            }

            .btn:active {
                transform: scale(0.98);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button class="lang-btn active" id="langRu" onclick="setLanguage('ru')">RU</button>
            <button class="lang-btn" id="langEn" onclick="setLanguage('en')">EN</button>
        </div>
        <h1 id="pageTitle">üå∏ –•–∞–Ω–∞—Ñ—É–¥–∞ - –ü–æ–¥—Å—á–µ—Ç –æ—á–∫–æ–≤ üå∏</h1>

        <div id="setupSection" class="setup-section">
            <div class="setup-row">
                <label for="player1Name">–ò–≥—Ä–æ–∫ 1:</label>
                <input type="text" id="player1Name" placeholder="–ò–≥—Ä–æ–∫ 1" value="–ò–≥—Ä–æ–∫ 1">
            </div>
            <div class="setup-row">
                <label for="player2Name">–ò–≥—Ä–æ–∫ 2:</label>
                <input type="text" id="player2Name" placeholder="–ò–≥—Ä–æ–∫ 2" value="–ò–≥—Ä–æ–∫ 2">
            </div>
            <div class="setup-row">
                <label for="initialPoints">–ù–∞—á–∞–ª—å–Ω—ã–µ –æ—á–∫–∏:</label>
                <div class="number-input-wrapper">
                    <button class="number-btn" onclick="decrementNumber('initialPoints', 0)">‚àí</button>
                    <input type="number" id="initialPoints" value="30" min="0">
                    <button class="number-btn" onclick="incrementNumber('initialPoints')">+</button>
                </div>
            </div>
            <div class="setup-row">
                <label for="totalRounds">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—É–Ω–¥–æ–≤:</label>
                <div class="number-input-wrapper">
                    <button class="number-btn" onclick="decrementNumber('totalRounds', 1)">‚àí</button>
                    <input type="number" id="totalRounds" value="12" min="1">
                    <button class="number-btn" onclick="incrementNumber('totalRounds')">+</button>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
        </div>

        <div id="gameSection" class="hidden">
            <div class="scores-section">
                <div class="player-score">
                    <h3 id="player1Display">–ò–≥—Ä–æ–∫ 1</h3>
                    <div class="points" id="player1Score">30</div>
                </div>
                <div class="player-score">
                    <h3 id="player2Display">–ò–≥—Ä–æ–∫ 2</h3>
                    <div class="points" id="player2Score">30</div>
                </div>
            </div>

            <div class="deal-section">
                <div class="deal-info">
                    <div class="deal-number" id="dealNumber"></div>
                </div>

                <div class="winner-select">
                    <label>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:</label>
                    <div class="winner-buttons" id="winnerButtons">
                        <button class="winner-btn" data-winner="player1" id="winnerBtn1"></button>
                        <button class="winner-btn" data-winner="player2" id="winnerBtn2"></button>
                    </div>
                </div>

                <div class="koi-koi-input">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ "–∫–æ–∏-–∫–æ–∏":</label>
                    <div class="number-input-wrapper">
                        <button class="number-btn" onclick="decrementNumber('koiKoiCount', 0, 10)">‚àí</button>
                        <input type="number" id="koiKoiCount" value="0" min="0" max="10">
                        <button class="number-btn" onclick="incrementNumber('koiKoiCount', 0, 10)">+</button>
                    </div>
                </div>

                <div class="yaku-section">
                    <h4>–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ (—è–∫—É) –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:</h4>
                    <div class="yaku-grid" id="yakuGrid"></div>
                </div>

                <div class="deal-result" id="dealResult">
                    <div>–û—á–∫–∏ –∑–∞ —Ä–∞–∑–¥–∞—á—É: <span class="points-earned" id="pointsEarned">0</span></div>
                </div>

                <div class="actions">
                    <button class="btn btn-success" id="submitDealBtn" onclick="submitDeal()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞–∑–¥–∞—á—É</button>
                    <button class="btn btn-cancel hidden" id="cancelEditBtn" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-danger" onclick="resetGame()">–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</button>
                </div>
            </div>

            <div class="history-section">
                <h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–¥–∞—á</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        // Localization
        const translations = {
            ru: {
                title: 'üå∏ –•–∞–Ω–∞—Ñ—É–¥–∞ - –ü–æ–¥—Å—á–µ—Ç –æ—á–∫–æ–≤ üå∏',
                player1: '–ò–≥—Ä–æ–∫ 1',
                player2: '–ò–≥—Ä–æ–∫ 2',
                initialPoints: '–ù–∞—á–∞–ª—å–Ω—ã–µ –æ—á–∫–∏',
                totalRounds: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—É–Ω–¥–æ–≤',
                startGame: '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É',
                deal: '–†–∞–∑–¥–∞—á–∞',
                of: '–∏–∑',
                winner: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å',
                koiKoiCount: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ "–∫–æ–∏-–∫–æ–∏"',
                yakuTitle: '–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ (—è–∫—É) –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:',
                pointsEarned: '–û—á–∫–∏ –∑–∞ —Ä–∞–∑–¥–∞—á—É:',
                submitDeal: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞–∑–¥–∞—á—É',
                saveChanges: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è',
                cancel: '–û—Ç–º–µ–Ω–∞',
                resetGame: '–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É',
                history: '–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–¥–∞—á',
                historyEmpty: '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞',
                extraCards: '–î–æ–ø. –∫–∞—Ä—Ç—ã:',
                gameOver: '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!',
                points: '–æ—á–∫–æ–≤',
                winnerLabel: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:',
                draw: '–ù–∏—á—å—è',
                confirmReset: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É?',
                selectWinner: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è!',
                selectYaku: '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–±–∏–Ω–∞—Ü–∏—é!',
                basePoints: '–±–∞–∑–æ–≤—ã–µ –æ—á–∫–∏:',
                edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                cards: '–∫–∞—Ä—Ç',
                combinations: '–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏:',
                stopOnNegative: '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏–≥—Ä—É –ø—Ä–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—á–∫–∞—Ö',
                gameStopped: '–ò–≥—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!',
                negativeScore: '—É—à–µ–ª –≤ –º–∏–Ω—É—Å',
                yaku: {
                    'goku': '–ì–æ–∫—É (5 –∫–∞—Ä—Ç)',
                    'shiko': '–®–∏–∫–æ (4 –∫–∞—Ä—Ç—ã)',
                    'ame-shiko': '–ê–º—ç-—à–∏–∫–æ (3 –∫–∞—Ä—Ç—ã —Å –¥–æ–∂–¥–µ–º)',
                    'sanko': '–°–∞–Ω–∫–æ (3 –∫–∞—Ä—Ç—ã)',
                    'ino-shika-cho': '–ò–Ω–æ-—à–∏–∫–æ-—á–æ',
                    'akatan': '–ê–∫–∞-—Ç–∞–Ω (–∫—Ä–∞—Å–Ω—ã–µ –ª–µ–Ω—Ç—ã)',
                    'aotan': '–ê–æ-—Ç–∞–Ω (—Å–∏–Ω–∏–µ –ª–µ–Ω—Ç—ã)',
                    'tan-zaku': '–¢–∞–Ω-–¥–∑–∞–∫—É (–ª–µ–Ω—Ç—ã)',
                    'tane': '–¢–∞–Ω–µ (–∂–∏–≤–æ—Ç–Ω—ã–µ)',
                    'kasu': '–ö–∞—Å—É (–ø—Ä–æ—Å—Ç—ã–µ)',
                    'tsukimi': '–¶—É–∫–∏–º–∏ (–ª—É–Ω–∞)',
                    'hanami': '–•–∞–Ω–∞–º–∏ (—Å–∞–∫—É—Ä–∞)'
                }
            },
            en: {
                title: 'üå∏ Hanafuda - Score Tracker üå∏',
                player1: 'Player 1',
                player2: 'Player 2',
                initialPoints: 'Initial Points',
                totalRounds: 'Number of Rounds',
                startGame: 'Start Game',
                deal: 'Deal',
                of: 'of',
                winner: 'Winner',
                koiKoiCount: 'Number of "koi-koi"',
                yakuTitle: 'Winner\'s Combinations (yaku):',
                pointsEarned: 'Points earned:',
                submitDeal: 'Submit Deal',
                saveChanges: 'Save Changes',
                cancel: 'Cancel',
                resetGame: 'Reset Game',
                history: 'Deal History',
                historyEmpty: 'History is empty',
                extraCards: 'Extra cards:',
                gameOver: 'Game Over!',
                points: 'points',
                winnerLabel: 'Winner:',
                draw: 'Draw',
                confirmReset: 'Are you sure you want to reset the game?',
                selectWinner: 'Select a winner!',
                selectYaku: 'Select at least one combination!',
                basePoints: 'base points:',
                edit: 'Edit',
                cards: 'cards',
                combinations: 'Combinations:',
                stopOnNegative: 'Stop game on negative points',
                gameStopped: 'Game stopped!',
                negativeScore: 'went negative',
                yaku: {
                    'goku': 'Goku (5 cards)',
                    'shiko': 'Shiko (4 cards)',
                    'ame-shiko': 'Ame-shiko (3 cards with rain)',
                    'sanko': 'Sanko (3 cards)',
                    'ino-shika-cho': 'Ino-shika-cho',
                    'akatan': 'Aka-tan (red ribbons)',
                    'aotan': 'Ao-tan (blue ribbons)',
                    'tan-zaku': 'Tan-zaku (ribbons)',
                    'tane': 'Tane (animals)',
                    'kasu': 'Kasu (plain)',
                    'tsukimi': 'Tsukimi (moon)',
                    'hanami': 'Hanami (cherry blossom)'
                }
            }
        };

        let currentLanguage = localStorage.getItem('hanafudaLanguage') || 'ru';

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('hanafudaLanguage', lang);
            applyLocalization();
            
            // Update language buttons
            document.getElementById('langRu').classList.toggle('active', lang === 'ru');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            // Update HTML lang attribute
            document.documentElement.lang = lang;
        }

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function applyLocalization() {
            const t = translations[currentLanguage];
            
            // Page title
            document.getElementById('pageTitle').textContent = t.title;
            
            // Setup section
            const player1Label = document.querySelector('label[for="player1Name"]');
            if (player1Label) player1Label.textContent = t.player1 + ':';
            document.getElementById('player1Name').placeholder = t.player1;
            
            const player2Label = document.querySelector('label[for="player2Name"]');
            if (player2Label) player2Label.textContent = t.player2 + ':';
            document.getElementById('player2Name').placeholder = t.player2;
            
            const initialPointsLabel = document.querySelector('label[for="initialPoints"]');
            if (initialPointsLabel) initialPointsLabel.textContent = t.initialPoints + ':';
            
            const totalRoundsLabel = document.querySelector('label[for="totalRounds"]');
            if (totalRoundsLabel) totalRoundsLabel.textContent = t.totalRounds + ':';
            
            const stopOnNegativeLabel = document.getElementById('stopOnNegativeLabel');
            if (stopOnNegativeLabel) stopOnNegativeLabel.textContent = t.stopOnNegative;
            
            document.querySelector('.btn-primary').textContent = t.startGame;
            
            // Game section labels
            const winnerLabel = document.querySelector('.winner-select label');
            if (winnerLabel) winnerLabel.textContent = t.winner + ':';
            
            const koiKoiLabel = document.querySelector('.koi-koi-input label');
            if (koiKoiLabel) koiKoiLabel.textContent = t.koiKoiCount + ':';
            
            const yakuTitle = document.querySelector('.yaku-section h4');
            if (yakuTitle) yakuTitle.textContent = t.yakuTitle;
            
            // Buttons
            const submitBtn = document.getElementById('submitDealBtn');
            if (submitBtn && !submitBtn.textContent.includes('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å') && !submitBtn.textContent.includes('Save')) {
                submitBtn.textContent = t.submitDeal;
            }
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.textContent = t.cancel;
            
            const resetBtn = document.querySelector('.btn-danger');
            if (resetBtn) resetBtn.textContent = t.resetGame;
            
            // History
            const historyTitle = document.querySelector('.history-section h3');
            if (historyTitle) historyTitle.textContent = t.history;
            
            // Update deal result label
            const dealResult = document.getElementById('dealResult');
            if (dealResult && dealResult.querySelector('div')) {
                dealResult.querySelector('div').innerHTML = t.pointsEarned + ' <span class="points-earned" id="pointsEarned">0</span>';
            }
            
            // Re-render yaku buttons with new translations
            if (document.getElementById('yakuGrid')) {
                renderYakuButtons();
            }
            
            // Update display
            if (gameState && gameState.player1Name) {
                updateDisplay();
            }
        }

        // Yaku combinations with their point values
        const YAKU = {
            'goku': { name: '–ì–æ–∫—É (5 –∫–∞—Ä—Ç)', points: 10 },
            'shiko': { name: '–®–∏–∫–æ (4 –∫–∞—Ä—Ç—ã)', points: 8 },
            'ame-shiko': { name: '–ê–º—ç-—à–∏–∫–æ (3 –∫–∞—Ä—Ç—ã —Å –¥–æ–∂–¥–µ–º)', points: 7 },
            'sanko': { name: '–°–∞–Ω–∫–æ (3 –∫–∞—Ä—Ç—ã)', points: 5 },
            'ino-shika-cho': { name: '–ò–Ω–æ-—à–∏–∫–æ-—á–æ', points: 5 },
            'akatan': { name: '–ê–∫–∞-—Ç–∞–Ω (–∫—Ä–∞—Å–Ω—ã–µ –ª–µ–Ω—Ç—ã)', points: 5 },
            'aotan': { name: '–ê–æ-—Ç–∞–Ω (—Å–∏–Ω–∏–µ –ª–µ–Ω—Ç—ã)', points: 5 },
            'tan-zaku': { name: '–¢–∞–Ω-–¥–∑–∞–∫—É (–ª–µ–Ω—Ç—ã)', points: 1 },
            'tane': { name: '–¢–∞–Ω–µ (–∂–∏–≤–æ—Ç–Ω—ã–µ)', points: 1 },
            'kasu': { name: '–ö–∞—Å—É (–ø—Ä–æ—Å—Ç—ã–µ)', points: 1 },
            'tsukimi': { name: '–¶—É–∫–∏–º–∏ (–ª—É–Ω–∞)', points: 5 },
            'hanami': { name: '–•–∞–Ω–∞–º–∏ (—Å–∞–∫—É—Ä–∞)', points: 5 }
        };

        let gameState = {
            player1Name: '–ò–≥—Ä–æ–∫ 1',
            player2Name: '–ò–≥—Ä–æ–∫ 2',
            player1Score: 30,
            player2Score: 30,
            initialPoints: 30,
            totalRounds: 12,
            currentDeal: 1,
            history: []
        };

        let editingDealIndex = null; // Index of deal being edited, null if not editing

        function loadGameState() {
            const saved = localStorage.getItem('hanafudaGame');
            if (saved) {
                gameState = JSON.parse(saved);
                restoreGame();
            }
        }

        function saveGameState() {
            localStorage.setItem('hanafudaGame', JSON.stringify(gameState));
        }

        function startGame() {
            gameState.player1Name = document.getElementById('player1Name').value || t('player1');
            gameState.player2Name = document.getElementById('player2Name').value || t('player2');
            gameState.initialPoints = parseInt(document.getElementById('initialPoints').value) || 30;
            gameState.totalRounds = parseInt(document.getElementById('totalRounds').value) || 12;
            gameState.player1Score = gameState.initialPoints;
            gameState.player2Score = gameState.initialPoints;
            gameState.currentDeal = 1;
            gameState.history = [];

            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            updateDisplay();
            saveGameState();
        }

        function restoreGame() {
            document.getElementById('player1Name').value = gameState.player1Name;
            document.getElementById('player2Name').value = gameState.player2Name;
            document.getElementById('initialPoints').value = gameState.initialPoints;
            document.getElementById('totalRounds').value = gameState.totalRounds;

            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            updateDisplay();
            renderHistory();
        }

        function updateDisplay() {
            document.getElementById('player1Display').textContent = gameState.player1Name;
            document.getElementById('player2Display').textContent = gameState.player2Name;
            document.getElementById('player1Score').textContent = gameState.player1Score;
            document.getElementById('player2Score').textContent = gameState.player2Score;
            const dealNumberEl = document.querySelector('.deal-number');
            if (dealNumberEl) {
                dealNumberEl.textContent = `${t('deal')} ${gameState.currentDeal} ${t('of')} ${gameState.totalRounds}`;
            }

            // Update winner buttons
            const winnerBtn1 = document.getElementById('winnerBtn1');
            const winnerBtn2 = document.getElementById('winnerBtn2');
            if (winnerBtn1) winnerBtn1.textContent = gameState.player1Name;
            if (winnerBtn2) winnerBtn2.textContent = gameState.player2Name;

            renderYakuButtons();
            clearDealInputs();
            
            // Disable inputs if game is over
            if (gameState.currentDeal > gameState.totalRounds) {
                disableDealInputs();
            } else {
                enableDealInputs();
            }
        }

        function getWinnerValue() {
            const activeBtn = document.querySelector('.winner-btn.active');
            return activeBtn ? activeBtn.dataset.winner : '';
        }

        function setWinnerValue(value) {
            document.querySelectorAll('.winner-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (value) {
                const btn = document.querySelector(`.winner-btn[data-winner="${value}"]`);
                if (btn) {
                    btn.classList.add('active');
                }
            }
        }

        function disableDealInputs() {
            document.querySelectorAll('.winner-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });
            document.getElementById('koiKoiCount').disabled = true;
            document.querySelectorAll('.yaku-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.6';
            });
            document.querySelectorAll('.extra-cards-input input').forEach(input => {
                if (input) input.disabled = true;
            });
            document.querySelector('.btn-success').disabled = true;
        }

        function enableDealInputs() {
            document.querySelectorAll('.winner-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled');
            });
            document.getElementById('koiKoiCount').disabled = false;
            document.querySelectorAll('.yaku-btn').forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            });
            document.querySelectorAll('.extra-cards-input input').forEach(input => {
                if (input) input.disabled = false;
            });
            document.querySelector('.btn-success').disabled = false;
        }

        function renderYakuButtons() {
            const grid = document.getElementById('yakuGrid');
            grid.innerHTML = '';
            
            // Yaku that need extra cards input
            const yakuWithExtraCards = ['kasu', 'tane', 'tan-zaku'];
            
            for (const [key, yaku] of Object.entries(YAKU)) {
                const btn = document.createElement('div');
                btn.className = 'yaku-btn';
                btn.dataset.yaku = key;
                
                let extraCardsHtml = '';
                if (yakuWithExtraCards.includes(key)) {
                    extraCardsHtml = `
                        <div class="extra-cards-input">
                            <label>${t('extraCards')}</label>
                            <div class="number-input-wrapper" onclick="event.stopPropagation();">
                                <button class="number-btn" onclick="event.stopPropagation(); decrementNumber('extra-cards-${key}', 0, 20); updateDealResult();">‚àí</button>
                                <input type="number" 
                                       id="extra-cards-${key}" 
                                       value="0" 
                                       min="0" 
                                       max="20"
                                       onclick="event.stopPropagation();"
                                       oninput="updateDealResult();">
                                <button class="number-btn" onclick="event.stopPropagation(); incrementNumber('extra-cards-${key}', 0, 20); updateDealResult();">+</button>
                            </div>
                        </div>
                    `;
                }
                
                const yakuName = translations[currentLanguage].yaku[key] || yaku.name;
                btn.innerHTML = `
                    <div>${yakuName}</div>
                    <div class="points">${yaku.points} ${t('points')}</div>
                    ${extraCardsHtml}
                `;
                btn.onclick = () => {
                    if (!btn.classList.contains('disabled')) {
                        toggleYaku(btn);
                        updateDealResult();
                    }
                };
                grid.appendChild(btn);
            }
            
            // Update button states after rendering
            updateYakuButtonsState();
        }

        function toggleYaku(btn) {
            const yakuKey = btn.dataset.yaku;
            const isActive = btn.classList.contains('active');
            
            // List of mutually exclusive light combinations
            const exclusiveLights = ['sanko', 'ame-shiko', 'shiko', 'goku'];
            
            // If activating a light combination
            if (!isActive && exclusiveLights.includes(yakuKey)) {
                // Deactivate all other light combinations
                exclusiveLights.forEach(key => {
                    if (key !== yakuKey) {
                        const otherBtn = document.querySelector(`[data-yaku="${key}"]`);
                        if (otherBtn && otherBtn.classList.contains('active')) {
                            otherBtn.classList.remove('active');
                            // Clear extra cards input if it exists
                            const extraCardsInput = document.getElementById(`extra-cards-${key}`);
                            if (extraCardsInput) {
                                extraCardsInput.value = 0;
                            }
                        }
                    }
                });
            }
            
            btn.classList.toggle('active');
            updateYakuButtonsState();
        }

        function updateYakuButtonsState() {
            // List of mutually exclusive light combinations
            const exclusiveLights = ['sanko', 'ame-shiko', 'shiko', 'goku'];
            
            // Find which light combination is currently active
            let activeLight = null;
            exclusiveLights.forEach(key => {
                const btn = document.querySelector(`[data-yaku="${key}"]`);
                if (btn && btn.classList.contains('active')) {
                    activeLight = key;
                }
            });
            
            // Update disabled state for all light combinations
            exclusiveLights.forEach(key => {
                const btn = document.querySelector(`[data-yaku="${key}"]`);
                if (btn) {
                    if (activeLight !== null && activeLight !== key) {
                        // Disable other light combinations if one is active
                        btn.classList.add('disabled');
                    } else {
                        // Enable if no light combination is active, or this is the active one
                        btn.classList.remove('disabled');
                    }
                }
            });
        }

        function clearDealInputs() {
            setWinnerValue('');
            document.getElementById('koiKoiCount').value = 0;
            document.querySelectorAll('.yaku-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.extra-cards-input input').forEach(input => {
                if (input) input.value = 0;
            });
            document.getElementById('dealResult').classList.remove('show');
            editingDealIndex = null;
            updateEditMode();
            updateYakuButtonsState();
        }

        function updateEditMode() {
            const submitBtn = document.getElementById('submitDealBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            
            if (editingDealIndex !== null) {
                submitBtn.textContent = t('saveChanges');
                cancelBtn.classList.remove('hidden');
            } else {
                submitBtn.textContent = t('submitDeal');
                cancelBtn.classList.add('hidden');
            }
        }

        function calculatePoints() {
            const winner = getWinnerValue();
            const koiKoiCount = parseInt(document.getElementById('koiKoiCount').value) || 0;
            const activeYaku = Array.from(document.querySelectorAll('.yaku-btn.active'))
                .map(btn => btn.dataset.yaku);

            if (!winner || activeYaku.length === 0) {
                return { total: 0, base: 0, multiplier: 1, koiKoiCount: 0 };
            }

            let basePoints = 0;
            const yakuPoints = [];
            const yakuWithExtraCards = ['kasu', 'tane', 'tan-zaku'];

            // Calculate base points for each yaku
            for (const yakuKey of activeYaku) {
                if (YAKU[yakuKey]) {
                    let yakuPointsValue = YAKU[yakuKey].points;
                    
                    // Add extra cards points for specific yaku
                    if (yakuWithExtraCards.includes(yakuKey)) {
                        const extraCardsInput = document.getElementById(`extra-cards-${yakuKey}`);
                        if (extraCardsInput) {
                            const extraCards = parseInt(extraCardsInput.value) || 0;
                            yakuPointsValue += extraCards; // Each extra card adds 1 point
                        }
                    }
                    
                    yakuPoints.push(yakuPointsValue);
                    basePoints += yakuPointsValue;
                }
            }

            // Apply doubling for koi-koi calls
            // Each koi-koi call doubles the points (2^n multiplier)
            const multiplier = Math.pow(2, koiKoiCount);
            const totalPoints = basePoints * multiplier;

            return { total: totalPoints, base: basePoints, multiplier: multiplier, koiKoiCount: koiKoiCount };
        }

        function updateDealResult() {
            const result = calculatePoints();
            const pointsEarned = document.getElementById('pointsEarned');
            const dealResult = document.getElementById('dealResult');
            
            if (result.total > 0) {
                let details = `${result.total} ${t('points')}`;
                if (result.koiKoiCount > 0) {
                    details += ` (${result.base} √ó 2^${result.koiKoiCount} = ${result.base} √ó ${result.multiplier})`;
                } else {
                    details += ` (${t('basePoints')} ${result.base})`;
                }
                pointsEarned.textContent = details;
                dealResult.classList.add('show');
            } else {
                dealResult.classList.remove('show');
            }
        }

        // Update result when inputs change
        document.addEventListener('DOMContentLoaded', () => {
            // Setup winner buttons using event delegation
            const winnerButtons = document.getElementById('winnerButtons');
            if (winnerButtons) {
                winnerButtons.addEventListener('click', (e) => {
                    if (e.target.classList.contains('winner-btn') && !e.target.disabled) {
                        setWinnerValue(e.target.dataset.winner);
                        updateDealResult();
                    }
                });
            }
            
            const koiKoiCount = document.getElementById('koiKoiCount');
            if (koiKoiCount) {
                koiKoiCount.addEventListener('input', updateDealResult);
            }
        });

        function submitDeal() {
            const winner = getWinnerValue();
            const koiKoiCount = parseInt(document.getElementById('koiKoiCount').value) || 0;
            const yakuWithExtraCards = ['kasu', 'tane', 'tan-zaku'];
            
            const activeYaku = Array.from(document.querySelectorAll('.yaku-btn.active'))
                .map(btn => {
                    const key = btn.dataset.yaku;
                    const yakuName = translations[currentLanguage].yaku[key] || YAKU[key].name;
                    const yakuData = { key, name: yakuName, points: YAKU[key].points };
                    
                    // Add extra cards count if applicable
                    if (yakuWithExtraCards.includes(key)) {
                        const extraCardsInput = document.getElementById(`extra-cards-${key}`);
                        if (extraCardsInput) {
                            yakuData.extraCards = parseInt(extraCardsInput.value) || 0;
                        }
                    }
                    
                    return yakuData;
                });

            if (!winner) {
                alert(t('selectWinner'));
                return;
            }

            if (activeYaku.length === 0) {
                alert(t('selectYaku'));
                return;
            }

            const result = calculatePoints();
            const points = result.total;
            const winnerName = winner === 'player1' ? gameState.player1Name : gameState.player2Name;

            if (editingDealIndex !== null) {
                // Editing existing deal
                const oldDeal = gameState.history[editingDealIndex];
                const oldPoints = oldDeal.points;
                const oldWinner = oldDeal.winner;
                
                // Revert old points
                if (oldWinner === gameState.player1Name) {
                    gameState.player1Score -= oldPoints;
                    gameState.player2Score += oldPoints;
                } else {
                    gameState.player2Score -= oldPoints;
                    gameState.player1Score += oldPoints;
                }
                
                // Update deal
                gameState.history[editingDealIndex] = {
                    deal: oldDeal.deal,
                    winner: winnerName,
                    koiKoiCount: koiKoiCount,
                    yaku: activeYaku,
                    points: points
                };
                
                // Apply new points
                if (winner === 'player1') {
                    gameState.player1Score += points;
                    gameState.player2Score -= points;
                } else {
                    gameState.player2Score += points;
                    gameState.player1Score -= points;
                }
                
                editingDealIndex = null;
            } else {
                // New deal
                // Update scores - winner gets points, loser loses points
                if (winner === 'player1') {
                    gameState.player1Score += points;
                    gameState.player2Score -= points;
                } else {
                    gameState.player2Score += points;
                    gameState.player1Score -= points;
                }

                // Add to history
                const historyItem = {
                    deal: gameState.currentDeal,
                    winner: winnerName,
                    koiKoiCount: koiKoiCount,
                    yaku: activeYaku,
                    points: points
                };
                gameState.history.push(historyItem);

                // Move to next deal
                gameState.currentDeal++;
            }

            updateDisplay();
            renderHistory();
            saveGameState();

            // Check if game is over
            if (gameState.currentDeal > gameState.totalRounds) {
                const winner = gameState.player1Score > gameState.player2Score 
                    ? gameState.player1Name 
                    : gameState.player2Score > gameState.player1Score
                    ? gameState.player2Name
                    : t('draw');
                setTimeout(() => {
                    alert(`${t('gameOver')}\n\n${gameState.player1Name}: ${gameState.player1Score} ${t('points')}\n${gameState.player2Name}: ${gameState.player2Score} ${t('points')}\n\n${t('winnerLabel')} ${winner}`);
                    disableDealInputs();
                }, 100);
            }
        }

        function editDeal(index) {
            const deal = gameState.history[index];
            editingDealIndex = index;
            
            // Set winner
            if (deal.winner === gameState.player1Name) {
                setWinnerValue('player1');
            } else {
                setWinnerValue('player2');
            }
            
            // Set koi-koi count
            document.getElementById('koiKoiCount').value = deal.koiKoiCount || 0;
            
            // Clear all yaku buttons
            document.querySelectorAll('.yaku-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.extra-cards-input input').forEach(input => {
                if (input) input.value = 0;
            });
            
            // Activate yaku from deal
            deal.yaku.forEach(yaku => {
                const btn = document.querySelector(`[data-yaku="${yaku.key}"]`);
                if (btn) {
                    btn.classList.add('active');
                    
                    // Set extra cards if applicable
                    if (yaku.extraCards && yaku.extraCards > 0) {
                        const extraCardsInput = document.getElementById(`extra-cards-${yaku.key}`);
                        if (extraCardsInput) {
                            extraCardsInput.value = yaku.extraCards;
                        }
                    }
                }
            });
            
            updateYakuButtonsState();
            updateDealResult();
            updateEditMode();
            
            // Scroll to form
            document.querySelector('.deal-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cancelEdit() {
            clearDealInputs();
            updateEditMode();
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (gameState.history.length === 0) {
                historyList.innerHTML = `<div class="history-item">${t('historyEmpty')}</div>`;
                return;
            }

            gameState.history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const yakuNames = item.yaku.map(y => {
                    let name = y.name;
                    if (y.extraCards && y.extraCards > 0) {
                        name += ` (+${y.extraCards} ${t('cards')})`;
                    }
                    return name;
                }).join(', ');
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'history-item-content';
                contentDiv.innerHTML = `
                    <strong>${t('deal')} ${item.deal}:</strong> ${item.winner} - ${item.points} ${t('points')}
                    ${item.koiKoiCount > 0 ? `(${item.koiKoiCount} ${t('koiKoiCount').toLowerCase()})` : ''}
                    <br><small>${t('combinations')} ${yakuNames}</small>
                `;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'history-item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-edit';
                editBtn.textContent = t('edit');
                editBtn.onclick = () => editDeal(index);
                actionsDiv.appendChild(editBtn);
                
                div.appendChild(contentDiv);
                div.appendChild(actionsDiv);
                historyList.appendChild(div);
            });
        }

        function resetGame() {
            if (confirm(t('confirmReset'))) {
                localStorage.removeItem('hanafudaGame');
                location.reload();
            }
        }

        // Number input increment/decrement functions
        function incrementNumber(inputId, min = null, max = null) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            let value = parseInt(input.value) || 0;
            value++;
            
            if (min !== null && value < min) value = min;
            if (max !== null && value > max) value = max;
            
            input.value = value;
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function decrementNumber(inputId, min = null, max = null) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            let value = parseInt(input.value) || 0;
            value--;
            
            if (min !== null && value < min) value = min;
            if (max !== null && value > max) value = max;
            
            input.value = value;
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Initialize language and load game state on page load
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage);
            loadGameState();
        });
    </script>
</body>
</html>